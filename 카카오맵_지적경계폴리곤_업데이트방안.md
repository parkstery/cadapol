# 카카오맵 지적 경계 폴리곤 기능 업데이트 방안

## 1. 현재 상황 분석

### 1.1 Reference 코드 분석 (Vworld-cadastral-polygon-creation)

**주요 기능:**
- 지도 클릭 시 해당 위치의 지적 필지 경계를 폴리곤으로 표시
- 주소 및 좌표 정보를 인포윈도우로 표시
- VWorld API를 사용하여 지적 정보 조회

**기술 스택:**
- `proj4` (v2.9.0): 좌표계 변환 (EPSG:5179 → EPSG:4326)
- VWorld API: 지적 정보 조회
  - 1단계: 좌표로 PNU 조회 (`LP_PA_CBND_BUBUN`)
  - 2단계: PNU로 폴리곤 Geometry 조회

**핵심 로직:**
1. 지도 클릭 이벤트 처리
2. 마커 표시
3. 카카오 Geocoder로 주소 변환
4. 인포윈도우 표시 (주소, 좌표 정보 포함)
5. VWorld API로 PNU 조회
6. PNU로 폴리곤 Geometry 조회
7. proj4로 좌표계 변환
8. 카카오맵 Polygon으로 그리기

**API 키:**
- VWorld API Key: `04FADF88-BBB0-3A72-8404-479547569E44`
- 허용 도메인: `https://cadapol.vercel.app/`

### 1.2 현재 프로젝트 카카오맵 주소보기 기능

**현재 구현:**
- 위치: `components/MapPane.tsx`의 `setupKakaoAddressClick()` 함수
- 기능: 지도 클릭 시 주소만 표시하고 3초 후 자동 사라짐
- 제한사항:
  - 지적 경계 폴리곤 기능 없음
  - 마커 표시 없음
  - 좌표 정보 표시 없음
  - 인포윈도우가 일시적 (3초 후 사라짐)

**코드 위치:**
```typescript
// components/MapPane.tsx:842-865
const setupKakaoAddressClick = () => {
  // 현재는 주소만 표시하고 3초 후 사라짐
}
```

## 2. 업데이트 방안

### 2.1 의존성 추가

**필요한 패키지:**
```json
{
  "dependencies": {
    "proj4": "2.9.0"
  },
  "devDependencies": {
    "@types/proj4": "^2.5.0"
  }
}
```

### 2.2 코드 구조 변경

#### 2.2.1 kakaoGisRef 확장

현재 `kakaoGisRef`에 다음 ref 추가:
- `cadastralMarker`: 지적 정보 조회 시 표시할 마커
- `cadastralPolygon`: 지적 경계 폴리곤
- `cadastralOverlay`: 인포윈도우 (기존 overlay와 분리)

```typescript
const kakaoGisRef = useRef<{
  // ... 기존 필드들
  cadastralMarker?: any;
  cadastralPolygon?: any;
  cadastralOverlay?: any;
}>({
  // ... 기존 초기값들
});
```

#### 2.2.2 함수 구조

1. **`clearCadastralGraphics()`**: 기존 지적 관련 그래픽 제거
2. **`setupKakaoAddressClick()`**: 기존 함수를 업그레이드
   - 마커 표시 추가
   - 인포윈도우 개선 (주소 + 좌표 정보)
   - 지적 경계 폴리곤 조회 호출
3. **`fetchCadastralInfoStep1()`**: 좌표로 PNU 조회
4. **`fetchGeometryByPNUStep2()`**: PNU로 폴리곤 Geometry 조회
5. **`drawParcelPolygon()`**: 폴리곤 그리기 (proj4 좌표계 변환 포함)

### 2.3 VWorld API 통합

**API 엔드포인트:**
- 1단계: `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=LP_PA_CBND_BUBUN&key={KEY}&geomFilter=POINT({lng} {lat})&domain={DOMAIN}&crs=EPSG:4326&format=json&errorFormat=json&geometry=false&callback={CALLBACK}`
- 2단계: `https://api.vworld.kr/req/data?service=data&request=GetFeature&data=LP_PA_CBND_BUBUN&key={KEY}&attrFilter=pnu:=:{PNU}&domain={DOMAIN}&crs=EPSG:4326&format=json&errorFormat=json&geometry=true&callback={CALLBACK}`

**JSONP 방식 사용:**
- CORS 이슈 해결을 위해 JSONP 콜백 방식 사용
- 동적 script 태그 생성 및 제거

### 2.4 인포윈도우 디자인 개선

**Reference 코드의 인포윈도우 스타일:**
- 글래스모피즘 효과
- 주소 (도로명주소 우선, 지번주소 보조)
- 좌표 정보 (X, Y)
- 말풍선 스타일 (아래쪽 화살표)

**현재 프로젝트에 적용:**
- 기존 `info-overlay` 클래스 대신 인라인 스타일 사용
- 더 상세한 정보 표시

### 2.5 좌표계 변환 (proj4)

**필요한 변환:**
- EPSG:5179 (한국 TM 좌표계) → EPSG:4326 (WGS84)

**구현:**
```typescript
proj4.defs("EPSG:5179", "+proj=tmerc +lat_0=38 +lon_0=127.5 +k=0.9996 +x_0=1000000 +y_0=2000000 +ellps=GRS80 +units=m +no_defs");
const proj = proj4("EPSG:5179", "EPSG:4326");
const [lon, lat] = proj.forward([coord[0], coord[1]]);
```

### 2.6 폴리곤 스타일

**Reference 코드 스타일:**
- Stroke: Orange-500 (#f97316), 두께 3px
- Fill: Orange-500, 투명도 20%

**현재 프로젝트에 적용:**
- 동일한 스타일 사용 또는 프로젝트 테마에 맞게 조정

## 3. 구현 단계

### 3.1 1단계: 의존성 설치
```bash
npm install proj4@2.9.0
npm install -D @types/proj4
```

### 3.2 2단계: 환경 변수 설정
- VWorld API Key를 환경 변수로 관리 (선택사항)
- 또는 상수로 정의

### 3.3 3단계: 코드 통합
1. `kakaoGisRef` 확장
2. `clearCadastralGraphics()` 함수 추가
3. `setupKakaoAddressClick()` 함수 업그레이드
4. VWorld API 호출 함수들 추가
5. `drawParcelPolygon()` 함수 추가

### 3.4 4단계: 테스트
- 다양한 위치에서 클릭 테스트
- 지적 정보가 없는 지역 처리 확인
- API 오류 처리 확인

## 4. 주의사항

### 4.1 API 키 관리
- VWorld API Key는 도메인 제한이 있을 수 있음
- 배포 시 허용 도메인 설정 필요
- 환경 변수로 관리 권장

### 4.2 에러 처리
- VWorld API 호출 실패 시 처리
- 지적 정보가 없는 지역 처리
- 좌표계 변환 실패 처리

### 4.3 성능 최적화
- 기존 그래픽 제거 후 새 그래픽 표시
- API 호출 중복 방지
- 메모리 누수 방지 (ref 정리)

### 4.4 기존 기능과의 충돌
- `gisMode !== GISMode.DEFAULT`일 때는 주소보기 기능 비활성화 (현재 로직 유지)
- 다른 모드(거리재기, 면적재기 등)와의 충돌 방지

## 5. 예상 결과

### 5.1 사용자 경험
- 지도 클릭 시 마커 표시
- 상세한 주소 및 좌표 정보 표시
- 지적 경계 폴리곤 시각화
- 정보가 지속적으로 표시 (3초 후 사라지지 않음)

### 5.2 기능 향상
- 단순 주소 표시 → 지적 정보 포함 상세 정보 표시
- 일시적 표시 → 지속적 표시
- 텍스트만 → 마커 + 폴리곤 + 인포윈도우

## 6. 참고 파일

- Reference: `reference/Vworld-cadastral-polygon-creation/index.tsx`
- 현재 구현: `components/MapPane.tsx` (842-865줄)
- 타입 정의: `types.ts`
