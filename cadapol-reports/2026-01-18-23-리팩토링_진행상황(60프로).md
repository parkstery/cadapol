# 리팩토링 진행 상황 점검 및 이후 작업 계획

**작성일**: 2026년 1월 18일  
**프로젝트명**: Cadapol (Advanced Dual Map Viewer)  
**상태**: 점진적 마이그레이션 진행 중

---

## 📋 목차

1. [현재 리팩토링 진행 상황](#1-현재-리팩토링-진행-상황)
2. [완료된 작업](#2-완료된-작업)
3. [진행 중인 작업](#3-진행-중인-작업)
4. [미완료 작업](#4-미완료-작업)
5. [이후 작업 계획](#5-이후-작업-계획)
6. [우선순위별 작업 목록](#6-우선순위별-작업-목록)

---

## 1. 현재 리팩토링 진행 상황

### 1.1 전체 진행률
**약 60% 완료** (구조 구축 기준)

### 1.2 리팩토링 단계
- ✅ **Phase 1**: 기반 구조 구축 (완료)
- ✅ **Phase 2**: GIS 도구 모듈화 (완료)
- ✅ **Phase 3**: 레이어 시스템 구축 (완료)
- ✅ **Phase 4**: 길찾기 시스템 구축 (완료)
- 🔄 **Phase 5**: 맵 제공자 분리 (진행 중, 약 70%)
- ⏳ **Phase 6**: MapPane.tsx 리팩토링 (예정)
- ⏳ **Phase 7**: 거리뷰 모듈 분리 (예정)

---

## 2. 완료된 작업

### 2.1 ✅ 기반 구조 구축

#### 인터페이스 정의
- ✅ `BaseMapProvider.ts`: MapProvider, Layer 인터페이스 정의
- ✅ `BaseLayer.ts`: Layer 기본 인터페이스 및 유틸리티
- ✅ `BaseRoutingProvider.ts`: RoutingProvider 인터페이스 정의

#### 팩토리 패턴
- ✅ `MapProviderFactory.ts`: 맵 제공자 생성 팩토리 구현
- ✅ 지원 맵 제공자: Google, Kakao, Naver

#### 타입 정의
- ✅ `types.ts`: 레이어, 길찾기 관련 타입 추가
  - `LayerType` enum
  - `LayerConfig` interface
  - `Waypoint`, `Route`, `RouteOptions` interface

### 2.2 ✅ GIS 도구 모듈화

#### 분리된 모듈
- ✅ `gis-tools/DistanceMeasure.ts`: 거리 측정 도구
- ✅ `gis-tools/AreaMeasure.ts`: 면적 측정 도구

#### 상태
- 모듈화 완료
- MapPane.tsx에서 사용 중

### 2.3 ✅ 레이어 시스템 구축

#### 구현된 컴포넌트
- ✅ `layers/BaseLayer.ts`: 레이어 기본 인터페이스 및 유틸리티
- ✅ `layers/LayerManager.tsx`: 레이어 관리자 클래스
- ✅ `layers/AdministrativeBoundaryLayer.tsx`: 행정경계 레이어 (향후 서비스로 이동 예정)

#### 기능
- 레이어 추가/제거
- 레이어 표시/숨김
- 레이어 투명도 조정
- 레이어 Z-index 관리
- 맵 제공자 변경 시 자동 재연결

### 2.4 ✅ 길찾기 시스템 구축

#### 구현된 컴포넌트
- ✅ `routing/BaseRoutingProvider.ts`: 라우팅 제공자 인터페이스
- ✅ `routing/RoutingManager.tsx`: 길찾기 관리자 클래스
- ✅ `routing/providers/GoogleRoutingProvider.tsx`: Google 길찾기
- ✅ `routing/providers/KakaoRoutingProvider.tsx`: Kakao 길찾기
- ✅ `routing/RoutingPanel.tsx`: 길찾기 UI 패널

#### 기능
- 출발지/목적지 설정
- 경유지 설정 (최대 4개)
- 경로 계산 및 표시
- 경로 정보 표시 (거리, 시간)
- 지명 검색 기반 경로 계산

### 2.5 🔄 맵 제공자 분리 (진행 중, 약 70%)

#### 구현된 Provider
- ✅ `map-providers/GoogleMapProvider.tsx`: Google Maps Provider
- ✅ `map-providers/KakaoMapProvider.tsx`: Kakao Maps Provider
- ✅ `map-providers/NaverMapProvider.tsx`: Naver Maps Provider

#### 현재 상태
- Provider 클래스 구현 완료
- MapPane.tsx에서 점진적 마이그레이션 진행 중
- `useNewProvider` 플래그로 새/기존 코드 전환
- 모든 맵 제공자(Google, Kakao, Naver)에서 새 Provider 사용 중

#### 미완료 사항
- ⚠️ 거리뷰/로드뷰 로직이 Provider에 완전히 통합되지 않음
- ⚠️ 일부 기능이 여전히 MapPane.tsx에 남아있음
- ⚠️ 기존 코드와 새 Provider 코드가 혼재

---

## 3. 진행 중인 작업

### 3.1 🔄 MapPane.tsx 점진적 마이그레이션

#### 현재 상태
- **파일 크기**: 약 3,500 lines (리팩토링 전: 3,106 lines)
- **마이그레이션 방식**: 점진적 전환 (`useNewProvider` 플래그)
- **새 Provider 사용**: Google, Kakao, Naver 모두 새 Provider 사용

#### 남은 작업
- ⚠️ 거리뷰/로드뷰 로직을 Provider로 완전히 이동
- ⚠️ 기존 코드 제거 (새 Provider로 완전 전환 후)
- ⚠️ 코드 정리 및 최적화

### 3.2 🔄 거리뷰 모듈 분리

#### 현재 상태
- 거리뷰 로직이 MapPane.tsx와 각 Provider에 분산
- Google Street View, Kakao Roadview, Naver Panorama 각각 구현

#### 필요한 작업
- 거리뷰 관련 로직을 별도 모듈로 분리
- `streetview/` 디렉토리 구조 구축
- 각 제공자별 거리뷰 Provider 구현

---

## 4. 미완료 작업

### 4.1 ⏳ MapPane.tsx 완전 리팩토링

#### 목표
- MapPane.tsx를 200-300 lines로 축소
- 모든 로직을 Provider, Layer, Routing 모듈로 이동
- 깔끔한 컴포넌트 구조

#### 현재 문제점
- 거리뷰 로직이 MapPane.tsx에 남아있음
- 일부 이벤트 리스너가 MapPane.tsx에 남아있음
- 기존 코드와 새 코드 혼재

### 4.2 ⏳ 거리뷰 모듈 분리

#### 목표 구조
```
streetview/
├── BaseStreetViewProvider.ts
├── GoogleStreetView.tsx
├── KakaoRoadView.tsx
└── NaverPanorama.tsx
```

#### 필요한 작업
- BaseStreetViewProvider 인터페이스 정의
- 각 제공자별 거리뷰 Provider 구현
- MapPane.tsx에서 거리뷰 로직 제거

### 4.3 ⏳ 커스텀 훅 분리

#### 목표 구조
```
hooks/
├── useMapProvider.ts
├── useMapSync.ts
├── useStreetView.ts
├── useLayerManager.ts
└── useRouting.ts
```

#### 필요한 작업
- 맵 동기화 로직을 `useMapSync` 훅으로 분리
- 거리뷰 로직을 `useStreetView` 훅으로 분리
- 레이어 관리를 `useLayerManager` 훅으로 분리
- 길찾기를 `useRouting` 훅으로 분리

### 4.4 ⏳ 행정경계 서비스 (향후 작업)

#### 결정 사항
- 행정경계 기능은 향후 서비스 항목으로 이동
- 현재 구현된 `AdministrativeBoundaryLayer.tsx`는 유지하되 비활성화
- VWorld API 관련 코드는 보존

---

## 5. 이후 작업 계획

### 5.1 단기 계획 (1-2주)

#### 우선순위 1: 거리뷰 모듈 분리
1. **BaseStreetViewProvider 인터페이스 정의**
   - 거리뷰 시작/종료 메서드
   - 위치 동기화 메서드
   - 리소스 정리 메서드

2. **각 제공자별 거리뷰 Provider 구현**
   - `GoogleStreetView.tsx`
   - `KakaoRoadView.tsx`
   - `NaverPanorama.tsx`

3. **MapPane.tsx에서 거리뷰 로직 제거**
   - 거리뷰 관련 refs 제거
   - 거리뷰 관련 함수 제거
   - 새 거리뷰 Provider 사용

#### 우선순위 2: 커스텀 훅 분리
1. **useMapSync 훅 구현**
   - 맵 동기화 로직 추출
   - 무한 루프 방지 로직 포함

2. **useStreetView 훅 구현**
   - 거리뷰 상태 관리
   - 거리뷰 Provider 관리

3. **useLayerManager 훅 구현**
   - LayerManager 인스턴스 관리
   - 레이어 추가/제거 함수 제공

4. **useRouting 훅 구현**
   - RoutingManager 인스턴스 관리
   - 경로 계산 함수 제공

#### 우선순위 3: MapPane.tsx 정리
1. **기존 코드 제거**
   - 새 Provider로 완전 전환 확인
   - 기존 맵 초기화 코드 제거
   - 중복 코드 제거

2. **코드 구조 개선**
   - 훅 사용으로 로직 분리
   - 컴포넌트 간소화
   - 가독성 향상

### 5.2 중기 계획 (2-4주)

#### 우선순위 1: 타입 안정성 강화
1. **`any` 타입 제거**
   - 맵 API 타입 정의 추가
   - 전역 객체 타입 정의
   - 타입 가드 함수 추가

2. **에러 처리 강화**
   - Provider 초기화 에러 처리
   - 레이어 로드 에러 처리
   - 길찾기 에러 처리

#### 우선순위 2: 성능 최적화
1. **메모이제이션**
   - `useMemo`로 Provider 인스턴스 메모이제이션
   - `useCallback`으로 함수 메모이제이션

2. **코드 스플릿팅**
   - 맵 제공자별 동적 import
   - 레이어별 동적 import
   - 길찾기 동적 import

#### 우선순위 3: 테스트 코드 작성
1. **단위 테스트**
   - 각 Provider 클래스 테스트
   - Layer 클래스 테스트
   - RoutingProvider 클래스 테스트

2. **통합 테스트**
   - MapPane 컴포넌트 테스트
   - LayerManager 테스트
   - RoutingManager 테스트

### 5.3 장기 계획 (1-2개월)

#### 우선순위 1: 새 맵 제공자 추가
1. **VWorldMapProvider 구현**
   - VWorld Map SDK 통합
   - 레이어 지원 강화

2. **OSMMapProvider 구현**
   - Leaflet 기반 구현
   - OSM 타일 레이어 지원

#### 우선순위 2: 고급 기능 추가
1. **3D 지도 지원**
   - Google Maps 3D
   - Naver Maps 3D

2. **오프라인 모드**
   - 타일 캐싱
   - 오프라인 지도 표시

---

## 6. 우선순위별 작업 목록

### 6.1 🔴 높은 우선순위 (즉시 시작)

#### 1. 거리뷰 모듈 분리
- [ ] `streetview/BaseStreetViewProvider.ts` 인터페이스 정의
- [ ] `streetview/GoogleStreetView.tsx` 구현
- [ ] `streetview/KakaoRoadView.tsx` 구현
- [ ] `streetview/NaverPanorama.tsx` 구현
- [ ] MapPane.tsx에서 거리뷰 로직 제거
- [ ] 통합 테스트

**예상 시간**: 3-5일

#### 2. 커스텀 훅 분리
- [ ] `hooks/useMapSync.ts` 구현
- [ ] `hooks/useStreetView.ts` 구현
- [ ] `hooks/useLayerManager.ts` 구현
- [ ] `hooks/useRouting.ts` 구현
- [ ] MapPane.tsx에서 훅 사용

**예상 시간**: 2-3일

#### 3. MapPane.tsx 정리
- [ ] 기존 코드 제거 (새 Provider로 완전 전환)
- [ ] 중복 코드 제거
- [ ] 코드 구조 개선
- [ ] 주석 정리

**예상 시간**: 2-3일

### 6.2 🟡 중간 우선순위 (1-2주 내)

#### 1. 타입 안정성 강화
- [ ] 맵 API 타입 정의 추가
- [ ] 전역 객체 타입 정의
- [ ] `any` 타입 제거
- [ ] 타입 가드 함수 추가

**예상 시간**: 3-5일

#### 2. 에러 처리 강화
- [ ] Provider 초기화 에러 처리
- [ ] 레이어 로드 에러 처리
- [ ] 길찾기 에러 처리
- [ ] 사용자 피드백 메시지

**예상 시간**: 2-3일

#### 3. 성능 최적화
- [ ] 메모이제이션 적용
- [ ] 코드 스플릿팅
- [ ] 불필요한 리렌더링 방지

**예상 시간**: 2-3일

### 6.3 🟢 낮은 우선순위 (향후)

#### 1. 테스트 코드 작성
- [ ] 단위 테스트 설정 (Jest)
- [ ] Provider 클래스 테스트
- [ ] Layer 클래스 테스트
- [ ] 통합 테스트

**예상 시간**: 1-2주

#### 2. 새 맵 제공자 추가
- [ ] VWorldMapProvider 구현
- [ ] OSMMapProvider 구현

**예상 시간**: 1주

#### 3. 고급 기능 추가
- [ ] 3D 지도 지원
- [ ] 오프라인 모드

**예상 시간**: 2-4주

---

## 7. 현재 코드 구조 분석

### 7.1 MapPane.tsx 현황

#### 파일 크기
- **현재**: 약 3,500 lines
- **목표**: 200-300 lines
- **진행률**: 약 10% (목표 대비)

#### 코드 구성
```
MapPane.tsx (약 3,500 lines)
├── Imports (20 lines)
├── 상수 및 설정 (10 lines)
├── Refs 및 상태 (50 lines)
├── 새 Provider 시스템 (200 lines) ✅
├── 기존 Google Maps 로직 (600 lines) ⚠️
├── 기존 Kakao Maps 로직 (800 lines) ⚠️
├── 기존 Naver Maps 로직 (600 lines) ⚠️
├── 거리뷰 로직 (500 lines) ⚠️
├── GIS 도구 로직 (400 lines) ✅ (일부 모듈화됨)
├── 지적 정보 조회 (300 lines) ⚠️
└── 렌더링 및 UI (220 lines)
```

#### 문제점
- ⚠️ 새 Provider 시스템과 기존 코드가 혼재
- ⚠️ 거리뷰 로직이 MapPane.tsx에 남아있음
- ⚠️ 일부 기능이 중복 구현됨
- ⚠️ 코드 가독성 저하

### 7.2 Provider 시스템 현황

#### 구현 상태
- ✅ **GoogleMapProvider**: 기본 기능 구현 완료
- ✅ **KakaoMapProvider**: 기본 기능 구현 완료
- ✅ **NaverMapProvider**: 기본 기능 구현 완료

#### 미완료 기능
- ⚠️ 거리뷰/로드뷰 통합 (부분적)
- ⚠️ 미니맵 관리
- ⚠️ 방향 표시 폴리곤

### 7.3 레이어 시스템 현황

#### 구현 상태
- ✅ **LayerManager**: 완전 구현
- ✅ **AdministrativeBoundaryLayer**: 구현 완료 (향후 서비스로 이동)

#### 미구현 레이어
- ⏳ **CadastralLayer**: 지적도 레이어 (기존 코드에 있음, 분리 필요)
- ⏳ **TopographicLayer**: 지형도 레이어

### 7.4 길찾기 시스템 현황

#### 구현 상태
- ✅ **RoutingManager**: 완전 구현
- ✅ **GoogleRoutingProvider**: 구현 완료
- ✅ **KakaoRoutingProvider**: 구현 완료
- ⏳ **NaverRoutingProvider**: 미구현

---

## 8. 리팩토링 로드맵

### Phase 1: 거리뷰 모듈 분리 (1주)
**목표**: 거리뷰 로직을 완전히 분리하여 MapPane.tsx 간소화

**작업 내용**:
1. BaseStreetViewProvider 인터페이스 정의
2. 각 제공자별 거리뷰 Provider 구현
3. MapPane.tsx에서 거리뷰 로직 제거
4. 통합 테스트

**예상 결과**:
- MapPane.tsx: 3,500 lines → 2,500 lines
- 거리뷰 로직: 완전 분리

### Phase 2: 커스텀 훅 분리 (1주)
**목표**: 로직을 훅으로 추출하여 MapPane.tsx 간소화

**작업 내용**:
1. useMapSync 훅 구현
2. useStreetView 훅 구현
3. useLayerManager 훅 구현
4. useRouting 훅 구현
5. MapPane.tsx에서 훅 사용

**예상 결과**:
- MapPane.tsx: 2,500 lines → 1,500 lines
- 로직 재사용성 향상

### Phase 3: 기존 코드 제거 (3일)
**목표**: 새 Provider로 완전 전환 후 기존 코드 제거

**작업 내용**:
1. 새 Provider로 모든 기능 동작 확인
2. 기존 맵 초기화 코드 제거
3. 중복 코드 제거
4. 코드 정리

**예상 결과**:
- MapPane.tsx: 1,500 lines → 500 lines
- 코드 가독성 향상

### Phase 4: 최종 정리 및 최적화 (1주)
**목표**: 코드 품질 향상 및 성능 최적화

**작업 내용**:
1. 타입 안정성 강화
2. 에러 처리 강화
3. 메모이제이션 적용
4. 코드 스플릿팅
5. 문서화

**예상 결과**:
- MapPane.tsx: 500 lines → 200-300 lines
- 코드 품질 향상
- 성능 최적화

---

## 9. 예상 최종 구조

### 9.1 목표 파일 구조

```
components/
├── MapPane.tsx                    # ~200-300 lines (목표)
│
├── map-providers/                 # 맵 제공자 모듈
│   ├── BaseMapProvider.ts
│   ├── GoogleMapProvider.tsx
│   ├── KakaoMapProvider.tsx
│   ├── NaverMapProvider.tsx
│   └── MapProviderFactory.ts
│
├── streetview/                    # 🆕 거리뷰 모듈
│   ├── BaseStreetViewProvider.ts
│   ├── GoogleStreetView.tsx
│   ├── KakaoRoadView.tsx
│   └── NaverPanorama.tsx
│
├── layers/                        # 레이어 모듈
│   ├── BaseLayer.ts
│   ├── LayerManager.tsx
│   └── AdministrativeBoundaryLayer.tsx (향후 서비스)
│
├── routing/                       # 길찾기 모듈
│   ├── BaseRoutingProvider.ts
│   ├── RoutingManager.tsx
│   ├── RoutingPanel.tsx
│   └── providers/
│       ├── GoogleRoutingProvider.tsx
│       ├── KakaoRoutingProvider.tsx
│       └── NaverRoutingProvider.tsx (추가 필요)
│
├── gis-tools/                     # GIS 도구 모듈
│   ├── DistanceMeasure.ts
│   └── AreaMeasure.ts
│
├── hooks/                         # 🆕 커스텀 훅
│   ├── useMapProvider.ts
│   ├── useMapSync.ts
│   ├── useStreetView.ts
│   ├── useLayerManager.ts
│   └── useRouting.ts
│
└── utils/                         # 유틸리티
    ├── constants.ts
    ├── geocoding.ts
    └── vworldApi.ts (행정경계는 향후 서비스)
```

### 9.2 MapPane.tsx 목표 구조

```typescript
// components/MapPane.tsx (목표: ~200-300 lines)

import React, { useRef } from 'react';
import { useMapProvider } from './hooks/useMapProvider';
import { useMapSync } from './hooks/useMapSync';
import { useStreetView } from './hooks/useStreetView';
import { useLayerManager } from './hooks/useLayerManager';
import { useRouting } from './hooks/useRouting';

const MapPane: React.FC<MapPaneProps> = (props) => {
  const containerRef = useRef<HTMLDivElement>(null);
  
  // 맵 제공자 관리
  const { provider, sdkLoaded } = useMapProvider(/* ... */);
  
  // 맵 동기화
  useMapSync(provider, props.globalState, props.onStateChange);
  
  // 거리뷰 관리
  useStreetView(provider, props.streetViewState, props.onStreetViewChange);
  
  // 레이어 관리
  const layerManager = useLayerManager(provider);
  
  // 길찾기 관리
  const routingManager = useRouting(provider, props.config.type);
  
  // 마커 설정
  useEffect(() => {
    if (provider && props.searchPos) {
      provider.setMarker(props.searchPos);
    }
  }, [provider, props.searchPos]);
  
  return (
    <div className="w-full h-full relative">
      <div ref={containerRef} className="w-full h-full" />
      {/* UI 컨트롤들 */}
    </div>
  );
};
```

---

## 10. 결론

### 10.1 현재 상태 요약

**완료된 작업**:
- ✅ 기반 구조 구축 (인터페이스, 팩토리)
- ✅ GIS 도구 모듈화
- ✅ 레이어 시스템 구축
- ✅ 길찾기 시스템 구축
- ✅ 맵 제공자 기본 구현 (70% 완료)

**진행 중인 작업**:
- 🔄 MapPane.tsx 점진적 마이그레이션
- 🔄 거리뷰 모듈 분리 준비

**미완료 작업**:
- ⏳ 거리뷰 모듈 완전 분리
- ⏳ 커스텀 훅 분리
- ⏳ MapPane.tsx 최종 정리
- ⏳ 타입 안정성 강화
- ⏳ 테스트 코드 작성

### 10.2 다음 단계

**즉시 시작할 작업** (우선순위 높음):
1. 거리뷰 모듈 분리 (3-5일)
2. 커스텀 훅 분리 (2-3일)
3. MapPane.tsx 정리 (2-3일)

**총 예상 시간**: 약 1-2주

### 10.3 예상 효과

**코드 품질**:
- MapPane.tsx: 3,500 lines → 200-300 lines (약 90% 감소)
- 모듈화로 가독성 향상
- 재사용성 향상
- 테스트 가능성 향상

**유지보수성**:
- 명확한 책임 분리
- 확장 용이성
- 버그 수정 용이성

---

**작성일**: 2026년 1월 18일  
**최종 수정일**: 2026년 1월 18일  
**다음 점검 예정일**: Phase 1 완료 후
